name: Git Checks

on:
  pull_request:
  merge_group:

jobs:
  block-fixup:
    if: github.event_name != 'merge_group'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Block Fixup Commit Merge
        uses: 13rac1/block-fixup-merge-action@bd5504fb9ca0253e109d98eb86b7debc01970cdc # v2.0.0

  conventional-commits:
    name: Lint Commits
    if: github.event_name != 'merge_group'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          # Setting it to ${{ github.event.pull_request.commits }} would not be
          # helpful, we need the history of main to find what --keep-base
          # means. (And relying on `HEAD^{${{ â€¦commits }}}` would not be
          # precise because it may not be linear, and the actual base commit is
          # not in GitHub's environment).
          fetch-depth: 0

      # If there are squash/fixup commits, the user will a) be aware of that
      # and b) that's checked separately -- so we autosquash first. (If that
      # doesn't work, *that* is an error of its own anyway).
      - name: Rebase to avoid fixups/squashes from obscuring actual errors
        run: |
          git config --global user.name "Committer of temporary autosquashes"
          git rebase origin/"${GITHUB_BASE_REF}" --autosquash --keep-base

      - uses: crate-ci/committed@master
